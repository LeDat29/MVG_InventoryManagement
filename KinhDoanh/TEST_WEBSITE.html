<!DOCTYPE html>
<html>
<head>
    <title>KHO MVG - Test Dá»¯ Liá»‡u</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        h2 { color: #444; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .data-box { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¢ KHO MVG - Test Há»‡ Thá»‘ng</h1>
        
        <h2>ğŸ” BÆ°á»›c 1: ÄÄƒng nháº­p</h2>
        <button id="loginBtn" class="btn">ÄÄƒng nháº­p (admin/admin123)</button>
        <div id="loginResult"></div>

        <h2>ğŸ‘¥ BÆ°á»›c 2: Test KhÃ¡ch hÃ ng</h2>
        <button id="customersBtn" class="btn">Táº£i danh sÃ¡ch khÃ¡ch hÃ ng</button>
        <div id="customersResult"></div>
        <div id="customersData" class="data-box" style="display:none;"></div>

        <h2>ğŸ“‹ BÆ°á»›c 3: Test Há»£p Ä‘á»“ng</h2>
        <button id="contractsBtn" class="btn">Táº£i danh sÃ¡ch há»£p Ä‘á»“ng</button>
        <div id="contractsResult"></div>
        <div id="contractsData" class="data-box" style="display:none;"></div>

        <h2>ğŸ“Š Káº¿t quáº£ tá»•ng</h2>
        <div id="summary" class="result">
            <strong>HÆ°á»›ng dáº«n:</strong><br>
            1. Click "ÄÄƒng nháº­p" trÆ°á»›c<br>
            2. Sau Ä‘Ã³ test khÃ¡ch hÃ ng vÃ  há»£p Ä‘á»“ng<br>
            3. Náº¿u thÃ nh cÃ´ng â†’ Website hoáº¡t Ä‘á»™ng tá»‘t!
        </div>
    </div>

    <script>
        let token = '';
        // Try these ports in order. Server defaults to 5001 in this repo; keep 5000 as fallback.
        const API_PORTS = [5001, 5000];
        const HOST = 'http://localhost';

        async function apiFetch(path, options = {}) {
            // Try each candidate base URL until one succeeds
            let lastError = null;
            for (const port of API_PORTS) {
                const url = `${HOST}:${port}${path}`;
                try {
                    const resp = await fetch(url, options);
                    // If response is received (even 4xx/5xx), return it for the caller to handle
                    return { response: resp, url };
                } catch (err) {
                    lastError = err;
                    // continue to next port
                }
            }
            // If none succeeded, throw last error
            throw lastError || new Error('No API ports available');
        }

        async function login() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<div class="result loading">Äang Ä‘Äƒng nháº­p...</div>';

            try {
                const { response, url } = await apiFetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                const data = await response.json();
                
                if (data.success && data.data && data.data.token) {
                    token = data.data.token;
                    resultDiv.innerHTML = `<div class="result success">âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!<br>User: ${data.data.user.full_name || data.data.user.username}<br>API: ${url}</div>`;
                    updateSummary();
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ Lá»—i: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c: ${error.message}</div>`;
            }
        }

        async function testCustomers() {
            if (!token) {
                alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }

            const resultDiv = document.getElementById('customersResult');
            const dataDiv = document.getElementById('customersData');
            
            resultDiv.innerHTML = '<div class="result loading">Äang táº£i khÃ¡ch hÃ ng...</div>';

            try {
                const { response } = await apiFetch('/api/customers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success && data.data && data.data.customers) {
                    const customers = data.data.customers;
                    resultDiv.innerHTML = `<div class="result success">âœ… TÃ¬m tháº¥y ${customers.length} khÃ¡ch hÃ ng!</div>`;
                    
                    let html = '<h3>Top 5 khÃ¡ch hÃ ng:</h3>';
                    customers.slice(0, 5).forEach((customer, index) => {
                        html += `<p><strong>${index + 1}. ${customer.name}</strong><br>
                                MÃ£: ${customer.customer_code} | Loáº¡i: ${customer.customer_type}<br>
                                LiÃªn há»‡: ${customer.phone || 'N/A'}</p>`;
                    });
                    
                    dataDiv.innerHTML = html;
                    dataDiv.style.display = 'block';
                    updateSummary();
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ Lá»—i: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ Lá»—i káº¿t ná»‘i: ${error.message}</div>`;
            }
        }

        async function testContracts() {
            if (!token) {
                alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }

            const resultDiv = document.getElementById('contractsResult');
            const dataDiv = document.getElementById('contractsData');
            
            resultDiv.innerHTML = '<div class="result loading">Äang táº£i há»£p Ä‘á»“ng...</div>';

            try {
                const { response } = await apiFetch('/api/contracts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (data.success && data.data && data.data.contracts) {
                    const contracts = data.data.contracts;
                    resultDiv.innerHTML = `<div class="result success">âœ… TÃ¬m tháº¥y ${contracts.length} há»£p Ä‘á»“ng!</div>`;
                    
                    let html = '<h3>Danh sÃ¡ch há»£p Ä‘á»“ng:</h3>';
                    contracts.forEach((contract, index) => {
                        const value = parseInt(contract.total_value).toLocaleString('vi-VN');
                        html += `<p><strong>${index + 1}. ${contract.contract_number}</strong><br>
                                KhÃ¡ch hÃ ng: ${contract.company_name}<br>
                                GiÃ¡ trá»‹: ${value} VNÄ | Tráº¡ng thÃ¡i: ${contract.status}</p>`;
                    });
                    
                    dataDiv.innerHTML = html;
                    dataDiv.style.display = 'block';
                    updateSummary();
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ Lá»—i: ${data.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ Lá»—i káº¿t ná»‘i: ${error.message}</div>`;
            }
        }

        function updateSummary() {
            const loginSuccess = token !== '';
            const customersSuccess = document.getElementById('customersData').style.display !== 'none';
            const contractsSuccess = document.getElementById('contractsData').style.display !== 'none';
            
            let summaryHtml = '<strong>Tráº¡ng thÃ¡i há»‡ thá»‘ng:</strong><br>';
            summaryHtml += `ğŸ” ÄÄƒng nháº­p: ${loginSuccess ? 'âœ… OK' : 'âŒ ChÆ°a'}<br>`;
            summaryHtml += `ğŸ‘¥ KhÃ¡ch hÃ ng: ${customersSuccess ? 'âœ… OK' : 'âŒ ChÆ°a'}<br>`;
            summaryHtml += `ğŸ“‹ Há»£p Ä‘á»“ng: ${contractsSuccess ? 'âœ… OK' : 'âŒ ChÆ°a'}<br>`;
            
            if (loginSuccess && customersSuccess && contractsSuccess) {
                summaryHtml += '<br><div class="result success"><strong>ğŸ‰ THÃ€NH CÃ”NG! Website hoáº¡t Ä‘á»™ng hoÃ n háº£o!</strong></div>';
            }
            
            document.getElementById('summary').innerHTML = summaryHtml;
        }

        // Attach event listeners and auto-login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('customersBtn').addEventListener('click', testCustomers);
            document.getElementById('contractsBtn').addEventListener('click', testContracts);

            // Auto login after a short delay
            setTimeout(login, 1000);
        });
    </script>
</body>
</html>