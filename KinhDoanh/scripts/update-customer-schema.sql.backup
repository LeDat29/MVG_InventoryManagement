-- Update Customer Schema to support new 3-tab structure

-- 1. Add new columns to customers table (check if not exists)
ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS full_name VARCHAR(100) AFTER contact_person;

ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS id_number VARCHAR(20) AFTER email;

ALTER TABLE customers 
ADD COLUMN IF NOT EXISTS customer_type ENUM('individual', 'company') DEFAULT 'individual' AFTER customer_code;

-- Update existing records
UPDATE customers SET 
    full_name = COALESCE(full_name, contact_person),
    customer_type = CASE 
        WHEN company_name IS NOT NULL AND company_name != '' THEN 'company'
        ELSE 'individual'
    END
WHERE full_name IS NULL OR customer_type IS NULL;

-- 2. Create customer_companies table (one customer can have multiple companies)
CREATE TABLE IF NOT EXISTS customer_companies (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    tax_code VARCHAR(20) NOT NULL,
    company_name VARCHAR(255) NOT NULL,
    invoice_address TEXT,
    warehouse_purpose VARCHAR(255),
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    UNIQUE KEY unique_customer_tax_code (customer_id, tax_code)
);

-- 3. Create customer_contracts table (one company can have multiple contracts)
CREATE TABLE IF NOT EXISTS customer_contracts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT NOT NULL,
    company_id INT NOT NULL,
    contract_number VARCHAR(50) NOT NULL UNIQUE,
    project_id INT,
    warehouse_location VARCHAR(255),
    representative_name VARCHAR(100),
    representative_position VARCHAR(50),
    area_sqm DECIMAL(10,2) DEFAULT 0,
    rental_price DECIMAL(15,2) DEFAULT 0,
    start_date DATE,
    end_date DATE,
    payment_terms TEXT,
    binding_terms TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE CASCADE,
    FOREIGN KEY (company_id) REFERENCES customer_companies(id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE SET NULL
);

-- 4. Migrate existing data to new structure
-- Migrate existing company data to customer_companies table
INSERT INTO customer_companies (customer_id, tax_code, company_name, invoice_address, warehouse_purpose, is_primary)
SELECT 
    id as customer_id,
    COALESCE(tax_code, '') as tax_code,
    COALESCE(company_name, full_name) as company_name,
    COALESCE(address, '') as invoice_address,
    'Kho hàng hóa tổng hợp' as warehouse_purpose,
    TRUE as is_primary
FROM customers 
WHERE id NOT IN (SELECT customer_id FROM customer_companies)
AND (company_name IS NOT NULL OR tax_code IS NOT NULL);

-- 5. Create indexes for better performance
CREATE INDEX idx_customer_companies_customer_id ON customer_companies(customer_id);
CREATE INDEX idx_customer_companies_tax_code ON customer_companies(tax_code);
CREATE INDEX idx_customer_contracts_customer_id ON customer_contracts(customer_id);
CREATE INDEX idx_customer_contracts_company_id ON customer_contracts(company_id);
CREATE INDEX idx_customer_contracts_contract_number ON customer_contracts(contract_number);
CREATE INDEX idx_customer_contracts_dates ON customer_contracts(start_date, end_date);

-- 6. Add triggers to update customer updated_at when related tables change
DELIMITER //

CREATE TRIGGER update_customer_on_company_change
    AFTER INSERT ON customer_companies
    FOR EACH ROW
BEGIN
    UPDATE customers SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.customer_id;
END//

CREATE TRIGGER update_customer_on_contract_change
    AFTER INSERT ON customer_contracts
    FOR EACH ROW
BEGIN
    UPDATE customers SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.customer_id;
END//

DELIMITER ;

-- 7. Update customer_code format if needed
UPDATE customers 
SET customer_code = CONCAT(
    CASE customer_type
        WHEN 'individual' THEN 'CN'
        ELSE 'DN'
    END,
    LPAD(id, 6, '0')
)
WHERE customer_code NOT REGEXP '^(CN|DN)[0-9]{6}$';

COMMIT;