/**
 * Server Entry Point - KHO MVG Management System
 * Hệ thống quản lý hỗ trợ kinh doanh các dự án kho xưởng
 * 
 * @description Khởi tạo server Express.js với cấu hình đầy đủ
 * @author KHO MVG Team
 * @version 1.0.0
 */

require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const morgan = require('morgan');
const path = require('path');

// Import configurations và middleware
const { connectMongoDB, connectMySQL } = require('./config/database');
const { initializeLogger, logger } = require('./config/logger');
const { generalLimiter } = require('./middleware/rateLimiter');
const { errorHandler } = require('./middleware/errorHandler');
const { authenticateToken } = require('./middleware/auth');

// Routes will be imported AFTER database connection is established

const app = express();
const PORT = process.env.PORT || 5000;

/**
 * Khởi tạo logger system
 */
initializeLogger();

/**
 * Security và Performance Middleware
 */
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'", "fonts.googleapis.com"],
            fontSrc: ["'self'", "fonts.gstatic.com", "data:"],
            scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'", "maps.googleapis.com", "kit.fontawesome.com", "cdn.jsdelivr.net"],
            imgSrc: ["'self'", "data:", "blob:", "*.googleapis.com", "*.gstatic.com"],
            connectSrc: ["'self'", "*.googleapis.com", "kit.fontawesome.com"],
            frameSrc: ["'self'"],
            objectSrc: ["'none'"],
            upgradeInsecureRequests: process.env.NODE_ENV === 'production' ? [] : null
        }
    },
    crossOriginEmbedderPolicy: false
}));

app.use(compression());
app.use(generalLimiter);

/**
 * CORS Configuration cho PWA support
 */
app.use(cors({
    origin: process.env.NODE_ENV === 'production' 
        ? ['https://your-domain.com'] 
        : ['http://localhost:3000', 'http://localhost:5000', 'http://127.0.0.1:5000'],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));

/**
 * Body parsing middleware
 */
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

/**
 * Logging middleware
 */
app.use(morgan('combined', {
    stream: {
        write: (message) => logger.info(message.trim())
    }
}));

/**
 * Static files serving - moved after API routes
 */

// API Routes will be registered AFTER database connection

/**
 * Health check endpoint
 */
app.get('/api/health', (req, res) => {
    res.json({
        status: 'OK',
        timestamp: new Date().toISOString(),
        version: '1.0.0',
        environment: process.env.NODE_ENV
    });
});

/**
 * PWA Service Worker - TEMPORARILY DISABLED
 */
// app.get('/sw.js', (req, res) => {
//     res.setHeader('Content-Type', 'application/javascript');
//     res.sendFile(path.resolve(__dirname, 'client/build/sw.js'));
// });

/**
 * Serve React App cho tất cả non-API routes
 * NOTE: Removed early catch-all that served client build before API routes were registered.
 * Routes are registered after database connections; a catch-all for frontend must be added
 * after API routes to avoid intercepting /api/* requests.
 */
app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'client/build/index.html'));
});

/**
 * Error handling middleware
 */
app.use(errorHandler);

/**
 * Database connections và server startup
 */
async function startServer() {
    try {
        // Auto-initialize database trước khi connect
        logger.info('🔧 Đang khởi tạo database...');
        const DatabaseAutoInit = require('./scripts/auto-init-db');
        const autoInit = new DatabaseAutoInit();
        const initSuccess = await autoInit.run();
        
        if (!initSuccess) {
            logger.error('❌ Không thể khởi tạo database');
            process.exit(1);
        }
        
        // Kết nối databases
        try {
            await connectMongoDB();
            logger.info('✅ MongoDB connected successfully');
        } catch (error) {
            logger.warn('⚠️  MongoDB không kết nối được, bỏ qua (optional)');
        }
        
        await connectMySQL();
        logger.info('✅ MySQL connected successfully');
        
        // NOW register routes AFTER database is connected
        logger.info('📋 Registering API routes...');
        const authRoutes = require('./routes/auth');
        const projectRoutes = require('./routes/projects');
        const customerRoutes = require('./routes/customers');
        const documentRoutes = require('./routes/documents');
        const apiDocsRoutes = require('./routes/apiDocs');
        const usersRoutes = require('./routes/users');
        const aiAssistantRoutes = require('./routes/ai-assistant');
        const clientErrorsRoutes = require('./routes/client-errors');
        
        app.use('/api/auth', authRoutes);
        app.use('/api/projects', authenticateToken, projectRoutes);
        app.use('/api/customers', authenticateToken, customerRoutes);
        app.use('/api/contracts', authenticateToken, require('./routes/contracts'));
        app.use('/api/contract-templates', authenticateToken, require('./routes/contract-templates'));
        app.use('/api/contract-documents', authenticateToken, require('./routes/contract-documents'));
        app.use('/api/documents', authenticateToken, documentRoutes);
        app.use('/api/users', authenticateToken, usersRoutes);
        app.use('/api/ai-assistant', require('./routes/ai-assistant'));
        app.use('/api/ai-configs', require('./routes/ai-assistant-configs'));
        app.use('/api/client-errors', clientErrorsRoutes);
        app.use('/api', require('./routes/metrics'));
        app.use('/api/docs', apiDocsRoutes);
        logger.info('✅ All API routes registered successfully');

        // Serve static files AFTER API routes to avoid conflicts
        app.use('/uploads', express.static(path.join(__dirname, 'uploads')));
        app.use(express.static(path.join(__dirname, 'client/build')));
        
        // Handle React Router - catch all other routes and return index.html
        app.get('*', (req, res) => {
            // Don't intercept API routes
            if (req.path.startsWith('/api/')) {
                return res.status(404).json({ success: false, message: 'API endpoint not found' });
            }
            res.sendFile(path.join(__dirname, 'client/build', 'index.html'));
        });
        
        // Khởi động server
        const server = app.listen(PORT, () => {
            logger.info(`🚀 KHO MVG Server đang chạy tại port ${PORT}`);
            logger.info(`📱 Environment: ${process.env.NODE_ENV}`);
            logger.info(`📚 API Docs: http://localhost:${PORT}/api/docs`);
        });

        // Graceful shutdown
        process.on('SIGTERM', () => {
            logger.info('SIGTERM nhận được, đang shutdown server...');
            server.close(() => {
                logger.info('Server đã đóng');
                process.exit(0);
            });
        });

        process.on('SIGINT', () => {
            logger.info('SIGINT nhận được, đang shutdown server...');
            server.close(() => {
                logger.info('Server đã đóng');
                process.exit(0);
            });
        });

    } catch (error) {
        logger.error('❌ Lỗi khởi động server:', error);
        process.exit(1);
    }
}

// Khởi động server
startServer();

module.exports = app;