/**
 * Database Configuration - KHO MVG
 * Cấu hình kết nối MongoDB và MySQL
 * 
 * @description Quản lý kết nối đến cả MongoDB (documents, logs) và MySQL (relational data)
 * MongoDB: Lưu trữ logs, files metadata, flexible documents
 * MySQL: Lưu trữ dữ liệu có cấu trúc như users, projects, contracts
 */

const mongoose = require('mongoose');
const mysql = require('mysql2/promise');
const { logger } = require('./logger');

// MongoDB Connection
let mongoConnection = null;

/**
 * Kết nối đến MongoDB
 * @returns {Promise<void>}
 */
async function connectMongoDB() {
    try {
        const mongoUri = process.env.NODE_ENV === 'test' 
            ? process.env.MONGODB_TEST_URI 
            : process.env.MONGODB_URI;

        // If no MongoDB URI, skip MongoDB connection
        if (!mongoUri || mongoUri === 'mongodb://localhost:27017/kho_mvg') {
            logger.warn('⚠️  MongoDB not configured or not available. Skipping MongoDB connection...');
            logger.info('✅ MySQL will be used for all data storage.');
            return null;
        }

        const options = {
            useNewUrlParser: true,
            useUnifiedTopology: true,
            maxPoolSize: 10,
            serverSelectionTimeoutMS: 3000, // Shorter timeout
            socketTimeoutMS: 45000,
        };

        mongoConnection = await mongoose.connect(mongoUri, options);
        
        mongoose.connection.on('error', (error) => {
            logger.error('MongoDB connection error:', error);
        });

        mongoose.connection.on('disrupted', () => {
            logger.warn('MongoDB connection disrupted');
        });

        mongoose.connection.on('reconnected', () => {
            logger.info('MongoDB reconnected');
        });

        logger.info('✅ MongoDB connected successfully');
        return mongoConnection;
    } catch (error) {
        logger.error('❌ MongoDB connection failed:', error.message);
        logger.warn('⚠️  Continuing without MongoDB. All data will use MySQL.');
        // Don't throw - allow server to start without MongoDB
        return null;
    }
}

// MySQL Connection Pool
let mysqlPool = null;

/**
 * Khởi tạo MySQL connection pool
 * @returns {Promise<mysql.Pool>}
 */
async function connectMySQL() {
    try {
        const config = {
            host: process.env.MYSQL_HOST || 'localhost',
            port: process.env.MYSQL_PORT || 3306,
            user: process.env.MYSQL_USER || 'root',
            password: process.env.MYSQL_PASSWORD || '',
            database: process.env.NODE_ENV === 'test' 
                ? process.env.MYSQL_TEST_DATABASE || 'kho_mvg_test'
                : process.env.MYSQL_DATABASE || 'kho_mvg',
            waitForConnections: true,
            connectionLimit: 10,
            queueLimit: 0,
            charset: 'utf8mb4'
        };

        mysqlPool = mysql.createPool(config);

        // Test connection
        const connection = await mysqlPool.getConnection();
        await connection.ping();
        connection.release();

        logger.info('✅ MySQL connection pool created successfully');
        return mysqlPool;
    } catch (error) {
        logger.error('Failed to connect to MySQL:', error);
        mysqlPool = null;
        throw error;
    }
}

/**
 * Khởi tạo database schemas và tables
 */
async function initializeDatabase() {
    try {
        await initializeMySQLTables();
        logger.info('Database initialization completed');
    } catch (error) {
        logger.error('Database initialization failed:', error);
        throw error;
    }
}

/**
 * Tạo các bảng MySQL cần thiết
 */
async function initializeMySQLTables() {
    const tables = [
        // Users table với role-based access
        `CREATE TABLE IF NOT EXISTS users (
            id INT PRIMARY KEY AUTO_INCREMENT,
            username VARCHAR(50) UNIQUE NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            password_hash VARCHAR(255) NOT NULL,
            full_name VARCHAR(100) NOT NULL,
            phone VARCHAR(20),
            role ENUM('admin', 'manager', 'staff', 'viewer') DEFAULT 'staff',
            permissions JSON,
            is_active BOOLEAN DEFAULT TRUE,
            last_login TIMESTAMP NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_by INT,
            INDEX idx_username (username),
            INDEX idx_email (email),
            INDEX idx_role (role)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Projects table - Thông tin cơ bản dự án kho
        `CREATE TABLE IF NOT EXISTS projects (
            id INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(200) NOT NULL,
            code VARCHAR(50) UNIQUE NOT NULL,
            description TEXT,
            address TEXT,
            province VARCHAR(100),
            district VARCHAR(100),
            ward VARCHAR(100),
            latitude DECIMAL(10, 8),
            longitude DECIMAL(11, 8),
            total_area DECIMAL(12, 2),
            used_area DECIMAL(12, 2) DEFAULT 0,
            available_area DECIMAL(12, 2),
            fixed_area DECIMAL(12, 2) DEFAULT 0,
            status ENUM('planning', 'construction', 'operational', 'maintenance') DEFAULT 'planning',
            owner_info JSON,
            legal_documents JSON,
            map_data JSON COMMENT 'Google Maps polygon data',
            warehouse_layout JSON COMMENT 'Internal warehouse zones layout',
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_by INT,
            INDEX idx_code (code),
            INDEX idx_status (status),
            INDEX idx_province (province),
            FOREIGN KEY (created_by) REFERENCES users(id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Warehouse Zones - Các khu vực kho trong dự án
        `CREATE TABLE IF NOT EXISTS warehouse_zones (
            id INT PRIMARY KEY AUTO_INCREMENT,
            project_id INT NOT NULL,
            zone_code VARCHAR(50) NOT NULL,
            zone_name VARCHAR(100),
            area DECIMAL(10, 2) NOT NULL,
            zone_type ENUM('rental', 'fixed_service', 'common_area') DEFAULT 'rental',
            status ENUM('available', 'rented', 'deposited', 'maintenance') DEFAULT 'available',
            rental_price DECIMAL(12, 2),
            coordinates JSON COMMENT 'Zone boundary coordinates',
            description TEXT,
            facilities JSON COMMENT 'Available facilities in zone',
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            UNIQUE KEY unique_zone (project_id, zone_code),
            INDEX idx_project_id (project_id),
            INDEX idx_status (status),
            INDEX idx_zone_type (zone_type),
            FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Customers table
        `CREATE TABLE IF NOT EXISTS customers (
            id INT PRIMARY KEY AUTO_INCREMENT,
            customer_code VARCHAR(50) UNIQUE NOT NULL,
            name VARCHAR(200),
            full_name VARCHAR(200),
            company_name VARCHAR(200),
            representative_name VARCHAR(100),
            representative_phone VARCHAR(20),
            representative_email VARCHAR(100),
            email VARCHAR(100),
            phone VARCHAR(20) NOT NULL,
            address TEXT,
            tax_code VARCHAR(50),
            business_license VARCHAR(100),
            bank_info JSON,
            id_number VARCHAR(100),
            warehouse_purpose TEXT,
            customer_type ENUM('individual', 'company') DEFAULT 'company',
            credit_rating ENUM('A', 'B', 'C', 'D') DEFAULT 'B',
            notes TEXT,
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_by INT,
            INDEX idx_customer_code (customer_code),
            INDEX idx_phone (phone),
            INDEX idx_email (email),
            FOREIGN KEY (created_by) REFERENCES users(id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Contracts table - Hợp đồng thuê kho
        `CREATE TABLE IF NOT EXISTS contracts (
            id INT PRIMARY KEY AUTO_INCREMENT,
            contract_number VARCHAR(100) UNIQUE NOT NULL,
            customer_id INT NOT NULL,
            project_id INT NOT NULL,
            zone_id INT NOT NULL,
            contract_type ENUM('new', 'renewal', 'amendment') DEFAULT 'new',
            start_date DATE NOT NULL,
            end_date DATE NOT NULL,
            rental_price DECIMAL(12, 2) NOT NULL,
            deposit_amount DECIMAL(12, 2),
            payment_cycle ENUM('monthly', 'quarterly', 'yearly') DEFAULT 'monthly',
            payment_terms TEXT,
            contract_terms TEXT,
            status ENUM('draft', 'active', 'expired', 'terminated', 'renewed') DEFAULT 'draft',
            auto_renewal BOOLEAN DEFAULT FALSE,
            renewal_notice_days INT DEFAULT 30,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_by INT,
            INDEX idx_contract_number (contract_number),
            INDEX idx_customer_id (customer_id),
            INDEX idx_project_id (project_id),
            INDEX idx_zone_id (zone_id),
            INDEX idx_status (status),
            INDEX idx_end_date (end_date),
            FOREIGN KEY (customer_id) REFERENCES customers(id),
            FOREIGN KEY (project_id) REFERENCES projects(id),
            FOREIGN KEY (zone_id) REFERENCES warehouse_zones(id),
            FOREIGN KEY (created_by) REFERENCES users(id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Document Categories - Quản lý danh mục hồ sơ
        `CREATE TABLE IF NOT EXISTS document_categories (
            id INT PRIMARY KEY AUTO_INCREMENT,
            category_code VARCHAR(50) UNIQUE NOT NULL,
            category_name VARCHAR(200) NOT NULL,
            category_type ENUM('project', 'customer', 'contract', 'task') NOT NULL,
            description TEXT,
            required_fields JSON,
            is_required BOOLEAN DEFAULT FALSE,
            sort_order INT DEFAULT 0,
            is_active BOOLEAN DEFAULT TRUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            INDEX idx_category_type (category_type),
            INDEX idx_sort_order (sort_order)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // Project Tasks - Công việc định kỳ tại dự án
        `CREATE TABLE IF NOT EXISTS project_tasks (
            id INT PRIMARY KEY AUTO_INCREMENT,
            project_id INT NOT NULL,
            task_name VARCHAR(200) NOT NULL,
            task_type ENUM('maintenance', 'inspection', 'safety_check', 'security_check', 'other') NOT NULL,
            description TEXT,
            schedule_type ENUM('daily', 'weekly', 'monthly', 'quarterly', 'yearly', 'custom') NOT NULL,
            schedule_config JSON COMMENT 'Cron-like schedule configuration',
            assigned_to INT,
            priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',
            estimated_duration INT COMMENT 'Duration in minutes',
            checklist JSON COMMENT 'Task checklist items',
            is_active BOOLEAN DEFAULT TRUE,
            next_due_date DATETIME,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            created_by INT,
            INDEX idx_project_id (project_id),
            INDEX idx_task_type (task_type),
            INDEX idx_next_due_date (next_due_date),
            INDEX idx_assigned_to (assigned_to),
            FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
            FOREIGN KEY (assigned_to) REFERENCES users(id),
            FOREIGN KEY (created_by) REFERENCES users(id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`,

        // User Activity Logs
        `CREATE TABLE IF NOT EXISTS user_logs (
            id INT PRIMARY KEY AUTO_INCREMENT,
            user_id INT,
            action VARCHAR(100) NOT NULL,
            resource_type VARCHAR(50),
            resource_id INT,
            ip_address VARCHAR(45),
            user_agent TEXT,
            details JSON,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            INDEX idx_user_id (user_id),
            INDEX idx_action (action),
            INDEX idx_created_at (created_at),
            FOREIGN KEY (user_id) REFERENCES users(id)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`
    ];

    for (const table of tables) {
        await mysqlPool.execute(table);
    }

    // Insert default admin user nếu chưa có
    await createDefaultAdmin();
}

/**
 * Tạo admin user mặc định
 */
async function createDefaultAdmin() {
    try {
        const [rows] = await mysqlPool.execute('SELECT COUNT(*) as count FROM users WHERE role = "admin"');
        
        if (rows[0].count === 0) {
            const bcrypt = require('bcryptjs');
            const crypto = require('crypto');
            
            // Generate secure random password or use env variable
            // Use environment variable if provided, otherwise fixed default for initial admin
            const defaultPassword = process.env.DEFAULT_ADMIN_PASSWORD || 'admin123!';
             const hashedPassword = await bcrypt.hash(defaultPassword, 12);
             
             logger.warn('='.repeat(80));
             logger.warn('ADMIN MẶC ĐỊNH ĐÃ ĐƯỢC TẠO');
             logger.warn(`Username: admin`);
             logger.warn(`Password: ${defaultPassword}`);
             logger.warn('QUAN TRỌNG: Đổi mật khẩu này NGAY sau lần đăng nhập đầu tiên!');
             logger.warn('='.repeat(80));
             
             await mysqlPool.execute(
                 `INSERT INTO users (username, email, password_hash, full_name, role, permissions) 
                  VALUES (?, ?, ?, ?, ?, ?)`,
                 [
                     'admin',
                     'admin@kho-mvg.com',
                     hashedPassword,
                     'Administrator',
                     'admin',
                     JSON.stringify(['all'])
                 ]
             );
            
             logger.info('Default admin user created: admin/admin123!');
         }
     } catch (error) {
         logger.error('Error creating default admin:', error);
     }
}

/**
 * Đóng kết nối databases
 */
async function closeDatabases() {
    try {
        if (mongoConnection) {
            await mongoose.connection.close();
        }
        if (mysqlPool) {
            await mysqlPool.end();
        }
        logger.info('Database connections closed');
    } catch (error) {
        logger.error('Error closing database connections:', error);
    }
}

// Export with mysqlPool wrapper
module.exports = {
    connectMongoDB,
    connectMySQL,
    initializeDatabase,
    // Return the actual pool; create lazily if not initialized so tests can use it
    mysqlPool: () => {
        if (!mysqlPool) {
            // Lazily create pool with same config as connectMySQL
            const config = {
                host: process.env.MYSQL_HOST || 'localhost',
                port: process.env.MYSQL_PORT || 3306,
                user: process.env.MYSQL_USER || 'root',
                password: process.env.MYSQL_PASSWORD || '',
                database: process.env.NODE_ENV === 'test'
                    ? process.env.MYSQL_TEST_DATABASE || process.env.MYSQL_DATABASE || 'kho_mvg'
                    : process.env.MYSQL_DATABASE || 'kho_mvg',
                waitForConnections: true,
                connectionLimit: 10,
                queueLimit: 0,
                charset: 'utf8mb4'
            };

            mysqlPool = mysql.createPool(config);
            logger.info('✅ MySQL pool lazily created by mysqlPool()');
        }
        return mysqlPool;
    },
    mongoConnection: () => mongoConnection,
    closeDatabases
};